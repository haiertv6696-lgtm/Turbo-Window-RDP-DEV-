name: RDP + Tailscale (Workflow 2)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:      { description: "Tailscale tailnet", required: true }
      ts_api_key:      { description: "Tailscale API key", required: true }
      ts_authkey:      { description: "Tailscale Auth key", required: true }
      quick_test:      { description: "Run 5-min test", type: boolean, default: false }
      runtime_minutes: { description: "Runtime", required: false, default: "355" }
      do_purge:        { description: "Purge bullet devices", required: false, default: "true" }
      rdp_count:       { description: "RDP count", required: false, default: "1" }
      cycles_left:     { description: "Cycles remaining", required: true }

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  run-rdp:
    runs-on: windows-latest
    timeout-minutes: 370
    env:
      RDP_USER: Bullettemporary
      RDP_PASS: Bullet@12345

    steps:
      - name: Setup Tailscale + RDP
        run: |
          $ts="$env:ProgramFiles\Tailscale\tailscale.exe"
          if(-not(Test-Path $ts)){
            $url="https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
            $dst="$env:TEMP\tailscale.msi"
            Invoke-WebRequest $url -OutFile $dst
            Start-Process msiexec.exe -ArgumentList "/i","`"$dst`"","/quiet","/norestart" -Wait
          }
          & $ts up --authkey "${{ inputs.ts_authkey }}" --hostname "bullet2" --accept-dns=true
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Install Python libs
        run: |
          python -m pip install --upgrade pip
          python -m pip install --force-reinstall pyautogui pynput pillow

      - name: Keep alive
        run: |
          $rt=[int]"${{ inputs.runtime_minutes }}"
          $end=(Get-Date).AddMinutes($rt)
          while((Get-Date) -lt $end){Write-Host ("Workflow2 heartbeat "+(Get-Date));Start-Sleep 60}

      - name: Dispatch STOP workflow
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $payload=@{
            ts_tailnet="${{ inputs.ts_tailnet }}"
            ts_api_key="${{ inputs.ts_api_key }}"
            ts_authkey="${{ inputs.ts_authkey }}"
            quick_test="${{ inputs.quick_test }}"
            runtime_minutes="${{ inputs.runtime_minutes }}"
            do_purge="${{ inputs.do_purge }}"
            rdp_count="${{ inputs.rdp_count }}"
            cycles_left="${{ inputs.cycles_left }}"
          }
          $url="https://api.github.com/repos/${{ github.repository }}/actions/workflows/workflow-stop.yml/dispatches"
          $hdr=@{Authorization="Bearer $env:GH_TOKEN";Accept="application/vnd.github+json"}
          $body=@{ref="${{ github.ref_name }}";inputs=$payload}|ConvertTo-Json -Depth 20
          Invoke-WebRequest -Method POST -Uri $url -Headers $hdr -Body $body|Out-Null
          Write-Host "ðŸ›‘ STOP workflow triggered (cycles left: ${{ inputs.cycles_left }})"
